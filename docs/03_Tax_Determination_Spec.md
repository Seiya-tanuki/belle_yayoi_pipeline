# 03_Tax_Determination_Spec

本書は「借方税区分」を決め打ちするための仕様である。AI推論は使わない。

## 1. 目標
1. 弥生の借方税区分（例：課対仕入込10%適格、課対仕入込軽減8%区分80%）を確定する。
2. 迷いは WARN/FAIL の品質ゲートへ送る（docs/05）。

## 2. 前提（v0）
1. 入力方式：**税込入力**（金額列は税込）
2. 出力税区分は「込」形式を使用（例：課対仕入込10%）
3. 取引は原則「課税対応仕入」（経費）として扱う（顧客要件より）
4. 税率は 10% と 軽減8% のみを扱う（その他は v0 では FAIL）

## 3. 税率（8/10）の確定手順
優先順位で確定する。

1. tax_breakdown に数値があり、rate_10 または rate_8 のいずれかで gross が確定できる：
   1) gross_amount_jpy がある → それを採用
   2) taxable_amount_jpy と tax_jpy がある → gross = taxable + tax
   3) gross が確定できない → 次へ
2. line_items から税率別に合計できる（tax_rate_basis が line/legend/document のいずれか）：
   1) basis が unknown の行は合計に含めない
   2) 合計が receipt_total_jpy と一致しない場合 → WARN（不一致）または FAIL（大きく乖離）
3. tax_meta.tax_rate_printed が 10 または 8 で、かつ単一税率が明確：
   1) gross_bucket = receipt_total_jpy
4. 上記で確定できない場合：
   1) 税率不明 → FAIL（原則）
   2) ただし運用で「10%既定」を許す場合は WARN（config化）

## 4. インボイス区分（適格/区分80/区分50/控不）
取引日付と登録番号の有無で決め打ちする（v0のデフォルト設定）。

1. 取引日付 < 2023-10-01：
   1) suffix = ""（付けない）
2. 取引日付 >= 2023-10-01：
   1) 登録番号あり → suffix = "適格"
   2) 登録番号なし → 期間で決定
      1) 2023-10-01〜2026-09-30 → "区分80%"
      2) 2026-10-01〜2029-09-30 → "区分50%"
      3) 2029-10-01〜 → "控不"

注意：弥生は suffix を省略しても「取引日付等から自動判定」できるが、v0では**明示する**（安定性重視）。

## 5. 税区分文字列の構成（v0：税込入力）
1. 税率10%： base = "課対仕入込10%"
2. 軽減8%： base = "課対仕入込軽減8%"
3. 借方税区分： base + suffix（suffixが空なら base のみ）

例：
1. 課対仕入込10%適格
2. 課対仕入込10%区分80%
3. 課対仕入込軽減8%区分50%

## 6. 決定表（Decision Table）
各 bucket（税率別）ごとに1行の弥生仕訳を出す。

1. rate=10, reg_noあり, date>=2023-10-01 → 課対仕入込10%適格
2. rate=8, reg_noなし, date=2025-11-30 → 課対仕入込軽減8%区分80%
3. rate=10, reg_noなし, date=2030-01-01 → 課対仕入込10%控不

## 7. WARN/FAILの基準（抜粋）
1. rate が 8/10 以外 → FAIL
2. 税率が確定できない → FAIL（既定）
3. has_multiple_rates=true なのに、bucket合計が total と合わない → WARN/FAIL（乖離率で）
