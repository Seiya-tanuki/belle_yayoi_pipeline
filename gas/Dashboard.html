<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root {
        --ink: #0c0d10;
        --muted: #4a5461;
        --panel: #ffffff;
        --shadow: rgba(12, 13, 16, 0.08);
        --accent: #f97316;
        --accent-dark: #c2410c;
        --accent-soft: #fff7ed;
        --line: #e5e7eb;
        --success: #16a34a;
        --danger: #dc2626;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 15% 10%, rgba(249, 115, 22, 0.18), transparent 35%),
          radial-gradient(circle at 85% 20%, rgba(14, 116, 144, 0.18), transparent 40%),
          linear-gradient(135deg, #fef3c7 0%, #f8fafc 45%, #e0f2fe 100%);
        min-height: 100vh;
      }

      .noise {
        position: fixed;
        inset: 0;
        background-image: linear-gradient(120deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 60%);
        opacity: 0.4;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .app {
        max-width: 1120px;
        margin: 0 auto;
        padding: 32px 20px 48px;
      }

      .hero {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 24px;
        animation: riseIn 0.6s ease both;
      }

      .hero-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: flex-end;
      }

      .hero-left {
        max-width: 560px;
      }

      h1 {
        font-family: "Georgia", "Times New Roman", serif;
        font-size: 2.1rem;
        margin: 0 0 6px;
        letter-spacing: 0.5px;
      }

      .build {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .rx {
        margin: 10px 0 8px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--line);
        box-shadow: 0 10px 24px var(--shadow);
      }

      .rx-current {
        display: flex;
        gap: 10px;
        align-items: baseline;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 8px;
      }

      .rx-label {
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        padding: 3px 8px;
        border-radius: 999px;
        background: #e2e8f0;
        color: var(--ink);
      }

      .rx-text {
        flex: 1;
      }

      .rx-current.rx-info .rx-label {
        background: #bae6fd;
        color: #0c4a6e;
      }

      .rx-current.rx-ok .rx-label {
        background: #bbf7d0;
        color: #14532d;
      }

      .rx-current.rx-warn .rx-label {
        background: #fde68a;
        color: #92400e;
      }

      .rx-current.rx-error .rx-label {
        background: #fecaca;
        color: #7f1d1d;
      }

      .rx-history {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 200px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .rx-entry {
        display: flex;
        gap: 8px;
        align-items: baseline;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .rx-entry .rx-label {
        padding: 2px 6px;
      }

      .rx-time {
        font-variant-numeric: tabular-nums;
        color: var(--muted);
      }

      .card {
        background: var(--panel);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 16px 40px var(--shadow);
        margin-bottom: 18px;
        border: 1px solid rgba(12, 13, 16, 0.06);
        animation: riseIn 0.6s ease both;
      }

      .hidden {
        display: none;
      }

      .delay-1 { animation-delay: 0.06s; }
      .delay-2 { animation-delay: 0.12s; }
      .delay-3 { animation-delay: 0.18s; }

      .card-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.2rem;
      }

      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .mode-panel {
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(12, 13, 16, 0.08);
        border-radius: 14px;
        padding: 12px 14px;
        min-width: 200px;
        box-shadow: 0 12px 24px var(--shadow);
      }

      .mode-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .mode-stack {
        display: flex;
        flex-direction: column;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .badge-running {
        background: var(--success);
        color: #fff;
      }

      .badge-stopped {
        background: var(--danger);
        color: #fff;
      }

      .mode-label {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .mode-value {
        font-weight: 700;
        font-size: 1.05rem;
        margin-top: 4px;
      }

      .mode-value.maintenance {
        color: var(--danger);
      }

      .mode-value.ocr {
        color: var(--success);
      }

      .mode-expiry {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .btn {
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--accent);
        color: #fff;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 10px 18px rgba(249, 115, 22, 0.2);
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(249, 115, 22, 0.3);
      }

      .btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: #0ea5e9;
        box-shadow: 0 10px 18px rgba(14, 165, 233, 0.2);
      }

      .btn-secondary:hover {
        box-shadow: 0 12px 24px rgba(14, 165, 233, 0.3);
      }

      .btn-ghost {
        background: #f3f4f6;
        color: var(--ink);
        box-shadow: none;
      }

      .btn-ghost:hover {
        box-shadow: 0 8px 16px rgba(12, 13, 16, 0.08);
      }

      .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-top-color: #fff;
        border-radius: 50%;
        display: none;
        animation: spin 0.8s linear infinite;
      }

      .btn.is-loading .spinner {
        display: inline-block;
      }

      .btn.is-loading .label {
        opacity: 0.7;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }

      th, td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid var(--line);
      }

      th {
        color: var(--muted);
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      tr.total-row {
        font-weight: 700;
        background: var(--accent-soft);
      }

      .ops-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .ops-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
      }

      .ops-block {
        background: #f8fafc;
        border-radius: 14px;
        padding: 14px;
        border: 1px solid var(--line);
      }

      .setup-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 12px 0 18px;
      }

      .setup-note {
        margin: 0 0 10px;
      }

      .ops-title {
        font-weight: 700;
        margin-bottom: 10px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .tab-btn {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 999px;
        padding: 6px 12px;
        cursor: pointer;
        font-weight: 600;
      }

      .tab-btn[aria-selected="true"] {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent-dark);
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      @keyframes riseIn {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @media (max-width: 900px) {
        .hero {
          flex-direction: column;
          align-items: flex-start;
        }
        .hero-controls {
          align-items: flex-start;
        }
        .actions {
          width: 100%;
        }
        table {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="noise" aria-hidden="true"></div>
    <main class="app">
      <header class="hero">
        <div class="hero-left">
          <h1>Belle Yayoi Pipeline Dashboard</h1>
          <div class="rx">
            <div class="rx-current rx-info" id="rx-current" aria-live="polite">
              <span class="rx-label">INFO</span>
              <span class="rx-text">Ready.</span>
            </div>
            <div class="rx-history" id="rx-history" aria-live="polite"></div>
          </div>
          <div class="build">Build: dashboard phase1</div>
        </div>
        <div class="hero-controls" id="header-controls">
          <div class="actions">
            <button class="btn btn-ghost" id="btn-refresh-overview">
              <span class="spinner" aria-hidden="true"></span>
              <span class="label">Refresh Overview</span>
            </button>
            <button class="btn btn-ghost" id="btn-refresh-logs">
              <span class="spinner" aria-hidden="true"></span>
              <span class="label">Refresh Logs</span>
            </button>
          </div>
          <div class="mode-panel" id="mode-panel" aria-live="polite">
            <div class="mode-row">
              <span id="ocr-run-badge" class="badge badge-stopped">OCR is stopped</span>
              <div class="mode-stack">
                <div class="mode-label">Mode</div>
                <div class="mode-value ocr" id="mode-value">OCR</div>
              </div>
            </div>
            <div class="mode-expiry" id="mode-expiry"></div>
          </div>
        </div>
      </header>

      <section class="card hidden" id="setup-view" aria-live="polite">
        <div class="card-header">
          <h2>Setup Required</h2>
          <div class="muted" id="setup-summary">Environment not ready.</div>
        </div>
        <p class="muted setup-note">Fix the issues below and click Re-check.</p>
        <div class="setup-actions">
          <button class="btn" id="btn-health-recheck">
            <span class="spinner" aria-hidden="true"></span>
            <span class="label">Re-check</span>
          </button>
        </div>
        <div class="table-wrap">
          <table id="setup-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Code</th>
                <th>Detail</th>
                <th>Hint</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <div id="dashboard-view" class="hidden">
        <section class="card delay-1" id="overview-section">
          <div class="card-header">
            <h2>Overview</h2>
            <div class="muted">Active doc types only</div>
          </div>
          <div class="table-wrap">
            <table id="overview-table">
              <thead>
                <tr>
                  <th>Doc Type</th>
                  <th>Queue Sheet</th>
                  <th>QUEUED</th>
                  <th>PROCESSING</th>
                  <th>ERROR_RETRYABLE</th>
                  <th>ERROR_FINAL</th>
                  <th>DONE</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="card delay-2" id="ops-section">
          <div class="card-header">
            <h2>Ops</h2>
            <div class="muted">Single-user execution</div>
          </div>
          <div class="ops-columns">
            <div class="ops-block">
              <div class="ops-title">OCR Ops</div>
              <div class="ops-grid">
                <button class="btn" id="btn-queue">
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="label">Queue Files</span>
                </button>
                <button class="btn btn-secondary" id="btn-ocr-enable">
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="label">OCR Enable</span>
                </button>
                <button class="btn btn-secondary" id="btn-ocr-disable">
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="label">OCR Disable</span>
                </button>
              </div>
            </div>
            <div class="ops-block">
              <div class="ops-title">Maintenance Ops</div>
              <div class="ops-grid">
                <button class="btn btn-ghost" id="btn-enter-maintenance">
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="label">Quiesce &amp; Enter</span>
                </button>
                <button class="btn" id="btn-export-run">
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="label">Export Run</span>
                </button>
                <button class="btn btn-ghost" id="btn-archive-logs">
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="label">Archive + Clear Logs</span>
                </button>
                <button class="btn btn-secondary" id="btn-exit-maintenance">
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="label">Exit Maintenance</span>
                </button>
              </div>
            </div>
          </div>
        </section>

        <section class="card delay-3" id="logs-section">
          <div class="card-header">
            <h2>Logs</h2>
            <div class="tabs" role="tablist">
              <button class="tab-btn" role="tab" aria-selected="true" aria-controls="log-guard" id="tab-guard-btn">Export Guard</button>
              <button class="tab-btn" role="tab" aria-selected="false" aria-controls="log-export-skip" id="tab-export-btn">Export Skip</button>
              <button class="tab-btn" role="tab" aria-selected="false" aria-controls="log-queue-skip" id="tab-queue-btn">Queue Skip</button>
            </div>
          </div>
          <div class="tab-panel active" id="log-guard" role="tabpanel" aria-labelledby="tab-guard-btn">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Reason</th>
                  <th>Doc Type</th>
                  <th>Counts</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="tab-panel" id="log-export-skip" role="tabpanel" aria-labelledby="tab-export-btn">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Reason</th>
                  <th>Doc Type</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="tab-panel" id="log-queue-skip" role="tabpanel" aria-labelledby="tab-queue-btn">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Reason</th>
                  <th>Doc Type</th>
                  <th>Seen</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <script>
      window.__BOOT_HEALTH__ = <?!= JSON.stringify(bootHealth || null) ?>;
    </script>
    <script>
      (function () {
        var ocrStatusErrorShown = false;
        var dashboardStarted = false;
        var rxMax = 30;
        var appState = {
          mode: "OCR",
          untilIso: ""
        };

        function rxNormalizeLevel(level) {
          var upper = String(level || "INFO").toUpperCase();
          if (upper === "OK" || upper === "INFO" || upper === "WARN" || upper === "ERROR") return upper;
          return "INFO";
        }

        function rxSetCurrent(level, msg) {
          var el = document.getElementById("rx-current");
          if (!el) return;
          var lvl = rxNormalizeLevel(level);
          el.className = "rx-current rx-" + lvl.toLowerCase();
          while (el.firstChild) el.removeChild(el.firstChild);
          var label = document.createElement("span");
          label.className = "rx-label";
          label.textContent = lvl;
          var text = document.createElement("span");
          text.className = "rx-text";
          text.textContent = msg ? String(msg) : "";
          el.appendChild(label);
          el.appendChild(text);
        }

        function rxBuildTimestamp_() {
          return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
        }

        function rxPush(level, msg) {
          var history = document.getElementById("rx-history");
          if (!history) return;
          var lvl = rxNormalizeLevel(level);
          var entry = document.createElement("div");
          entry.className = "rx-entry rx-" + lvl.toLowerCase();
          var time = document.createElement("span");
          time.className = "rx-time";
          time.textContent = "[" + rxBuildTimestamp_() + "]";
          var label = document.createElement("span");
          label.className = "rx-label";
          label.textContent = lvl;
          var text = document.createElement("span");
          text.className = "rx-text";
          text.textContent = msg ? String(msg) : "";
          entry.appendChild(time);
          entry.appendChild(label);
          entry.appendChild(text);
          history.insertBefore(entry, history.firstChild);
          while (history.childNodes.length > rxMax) {
            history.removeChild(history.lastChild);
          }
          rxSetCurrent(lvl, msg);
        }

        function setEnabled(btn, enabled) {
          if (!btn) return;
          if (btn.classList.contains("is-loading")) return;
          btn.disabled = !enabled;
        }

        function setLoading(btn, isLoading) {
          if (!btn) return;
          btn.disabled = isLoading;
          if (isLoading) btn.classList.add("is-loading");
          else btn.classList.remove("is-loading");
        }

        function setHeaderControlsVisible(visible) {
          var controls = document.getElementById("header-controls");
          if (!controls) return;
          if (visible) controls.classList.remove("hidden");
          else controls.classList.add("hidden");
        }

        function applyModeState(state) {
          var mode = state && state.mode ? String(state.mode).toUpperCase() : "OCR";
          if (mode !== "MAINTENANCE") mode = "OCR";
          var untilIso = state && state.until_iso ? String(state.until_iso) : "";
          appState.mode = mode;
          appState.untilIso = untilIso;

          var modeValue = document.getElementById("mode-value");
          var modeExpiry = document.getElementById("mode-expiry");
          if (modeValue) {
            modeValue.textContent = mode;
            modeValue.classList.remove("maintenance", "ocr");
            modeValue.classList.add(mode === "MAINTENANCE" ? "maintenance" : "ocr");
          }
          if (modeExpiry) {
            modeExpiry.textContent = mode === "MAINTENANCE" && untilIso ? ("Until " + untilIso) : "";
          }

          var controls = appState.controls || {};
          var isMaintenance = mode === "MAINTENANCE";
          setEnabled(controls.btnQueue, !isMaintenance);
          setEnabled(controls.btnOcrEnable, !isMaintenance);
          setEnabled(controls.btnOcrDisable, !isMaintenance);
          setEnabled(controls.btnEnterMaintenance, !isMaintenance);
          setEnabled(controls.btnExportRun, isMaintenance);
          setEnabled(controls.btnArchiveLogs, isMaintenance);
          setEnabled(controls.btnExitMaintenance, isMaintenance);
        }

        function refreshMode(options) {
          var opts = options || {};
          var button = opts.button;
          setLoading(button, true);
          callServer("belle_dash_getMode", undefined, function (err, res) {
            setLoading(button, false);
            if (err) {
              rxSetCurrent("ERROR", "Mode refresh failed.");
              return;
            }
            if (!res.ok) {
              rxSetCurrent("ERROR", res.message || "Mode refresh failed.");
              return;
            }
            applyModeState(res.data || {});
          });
        }

        function refreshOcrRunStatus() {
          callServer("belle_dash_getOcrRunStatus", undefined, function (err, res) {
            if (err || !res || !res.ok) {
              if (!ocrStatusErrorShown) {
                rxSetCurrent("WARN", "Could not refresh OCR status.");
                ocrStatusErrorShown = true;
              }
              return;
            }
            ocrStatusErrorShown = false;
            var running = res.data && res.data.running === true;
            var badge = document.getElementById("ocr-run-badge");
            if (!badge) return;
            badge.className = "badge " + (running ? "badge-running" : "badge-stopped");
            badge.textContent = running ? "OCR is running" : "OCR is stopped";
          });
        }

        function callServer(fnName, payload, callback) {
          var runner = google.script.run
            .withSuccessHandler(function (res) {
              callback(null, res);
            })
            .withFailureHandler(function (err) {
              callback(err, null);
            });
          if (payload !== undefined) runner[fnName](payload);
          else runner[fnName]();
        }

        function renderSetupDiagnostics(diags) {
          var tbody = document.querySelector("#setup-table tbody");
          tbody.innerHTML = "";
          if (!diags || diags.length === 0) {
            var empty = document.createElement("tr");
            var td = document.createElement("td");
            td.colSpan = 4;
            td.textContent = "No diagnostics available.";
            empty.appendChild(td);
            tbody.appendChild(empty);
            return;
          }
          diags.forEach(function (entry) {
            var tr = document.createElement("tr");
            var cells = [entry.item, entry.code, entry.detail, entry.hint];
            cells.forEach(function (value) {
              var td = document.createElement("td");
              td.textContent = value === undefined || value === null ? "" : String(value);
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        }

        function showSetupView(res) {
          var setup = document.getElementById("setup-view");
          var dashboard = document.getElementById("dashboard-view");
          if (dashboard) dashboard.classList.add("hidden");
          if (setup) setup.classList.remove("hidden");
          setHeaderControlsVisible(false);
          var summary = document.getElementById("setup-summary");
          var message = res && res.message ? String(res.message) : "Environment not ready.";
          if (summary) summary.textContent = message;
          var diags = res && res.data && res.data.diagnostics ? res.data.diagnostics : [];
          renderSetupDiagnostics(diags);
        }

        function showDashboardView() {
          var setup = document.getElementById("setup-view");
          var dashboard = document.getElementById("dashboard-view");
          if (setup) setup.classList.add("hidden");
          if (dashboard) dashboard.classList.remove("hidden");
          setHeaderControlsVisible(true);
          if (!dashboardStarted) {
            dashboardStarted = true;
            initDashboard();
          }
        }

        function applyHealthResult(res) {
          var data = res && res.data ? res.data : null;
          var ready = data && data.ready === true;
          if (ready) {
            rxSetCurrent("OK", "Environment ready.");
            showDashboardView();
          } else {
            rxSetCurrent("WARN", "Environment not ready.");
            showSetupView(res);
          }
        }

        function renderOverview(res) {
          var tbody = document.querySelector("#overview-table tbody");
          tbody.innerHTML = "";
          var data = res && res.data ? res.data : null;
          var rows = data && data.docTypes ? data.docTypes : [];
          var totals = data && data.totals ? data.totals : null;
          if (!rows || rows.length === 0) {
            var empty = document.createElement("tr");
            var td = document.createElement("td");
            td.colSpan = 7;
            td.textContent = "No overview data.";
            empty.appendChild(td);
            tbody.appendChild(empty);
            return;
          }

          rows.forEach(function (row) {
            var tr = document.createElement("tr");
            if (row.missing) tr.classList.add("muted");
            var cells = [
              row.docType || "",
              row.queueSheetName || "",
              row.counts ? row.counts.queued : 0,
              row.counts ? row.counts.processing : 0,
              row.counts ? row.counts.error_retryable : 0,
              row.counts ? row.counts.error_final : 0,
              row.counts ? row.counts.done : 0
            ];
            cells.forEach(function (value) {
              var td = document.createElement("td");
              td.textContent = String(value);
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          if (totals) {
            var totalRow = document.createElement("tr");
            totalRow.className = "total-row";
            var totalCells = [
              "Totals",
              "",
              totals.queued || 0,
              totals.processing || 0,
              totals.error_retryable || 0,
              totals.error_final || 0,
              totals.done || 0
            ];
            totalCells.forEach(function (value) {
              var td = document.createElement("td");
              td.textContent = String(value);
              totalRow.appendChild(td);
            });
            tbody.appendChild(totalRow);
          }
        }

        function countsToText(counts) {
          if (!counts) return "-";
          var parts = [];
          if (counts.total !== null && counts.total !== undefined) parts.push("total " + counts.total);
          if (counts.done !== null && counts.done !== undefined) parts.push("done " + counts.done);
          if (counts.queued !== null && counts.queued !== undefined) parts.push("queued " + counts.queued);
          if (counts.retryable !== null && counts.retryable !== undefined) parts.push("retryable " + counts.retryable);
          if (counts.error_final !== null && counts.error_final !== undefined) parts.push("error_final " + counts.error_final);
          return parts.length > 0 ? parts.join(", ") : "-";
        }

        function renderLogTable(tableId, rows, columns, emptyText) {
          var tbody = document.querySelector(tableId + " tbody");
          tbody.innerHTML = "";
          if (!rows || rows.length === 0) {
            var empty = document.createElement("tr");
            var td = document.createElement("td");
            td.colSpan = columns.length;
            td.textContent = emptyText;
            empty.appendChild(td);
            tbody.appendChild(empty);
            return;
          }
          rows.forEach(function (row) {
            var tr = document.createElement("tr");
            columns.forEach(function (col) {
              var td = document.createElement("td");
              var value = row[col];
              if (col === "counts") value = countsToText(row.counts);
              if (col === "seen_count") value = row.seen_count !== null && row.seen_count !== undefined ? row.seen_count : "-";
              td.textContent = value === undefined || value === null ? "-" : String(value);
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        }

        function renderLogs(res) {
          var data = res && res.data ? res.data : null;
          var sheets = data && data.sheets ? data.sheets : {};
          var guard = sheets.exportGuard || {};
          var exportSkip = sheets.exportSkip || {};
          var queueSkip = sheets.queueSkip || {};
          var guardEmpty = guard.missing ? "Sheet not found." : "No guard logs.";
          var exportEmpty = exportSkip.missing ? "Sheet not found." : "No export skip logs.";
          var queueEmpty = queueSkip.missing ? "Sheet not found." : "No queue skip logs.";

          renderLogTable("#log-guard", guard.rows, ["ts_iso", "reason", "doc_type", "counts"], guardEmpty);
          renderLogTable("#log-export-skip", exportSkip.rows, ["ts_iso", "reason", "doc_type"], exportEmpty);
          renderLogTable("#log-queue-skip", queueSkip.rows, ["ts_iso", "reason", "doc_type", "seen_count"], queueEmpty);
        }

        function refreshOverview(options) {
          var opts = options || {};
          var button = opts.button;
          var history = opts.history === true;
          var onError = typeof opts.onError === "function" ? opts.onError : null;
          setLoading(button, true);
          if (history) rxPush("INFO", "Refreshing overview...");
          else rxSetCurrent("INFO", "Refreshing overview...");
          callServer("belle_dash_getOverview", undefined, function (err, res) {
            setLoading(button, false);
            if (err) {
              if (onError) {
                onError();
                return;
              }
              if (history) rxPush("ERROR", "Overview failed to load.");
              else rxSetCurrent("ERROR", "Overview failed to load.");
              return;
            }
            if (!res.ok) {
              if (onError) {
                onError();
                return;
              }
              var msg = res.message || "Overview failed.";
              if (history) rxPush("ERROR", msg);
              else rxSetCurrent("ERROR", msg);
              return;
            }
            renderOverview(res);
            if (history) rxPush("OK", "Overview updated.");
            else rxSetCurrent("OK", "Overview updated.");
          });
        }

        function refreshLogs(options) {
          var opts = options || {};
          var button = opts.button;
          var history = opts.history === true;
          setLoading(button, true);
          if (history) rxPush("INFO", "Refreshing logs...");
          else rxSetCurrent("INFO", "Refreshing logs...");
          callServer("belle_dash_getLogs", undefined, function (err, res) {
            setLoading(button, false);
            if (err) {
              if (history) rxPush("ERROR", "Logs failed to load.");
              else rxSetCurrent("ERROR", "Logs failed to load.");
              return;
            }
            if (!res.ok) {
              var msg = res.message || "Logs failed.";
              if (history) rxPush("ERROR", msg);
              else rxSetCurrent("ERROR", msg);
              return;
            }
            renderLogs(res);
            if (history) rxPush("OK", "Logs updated.");
            else rxSetCurrent("OK", "Logs updated.");
          });
        }

        function runOp(button, fnName, confirmText, successText, options) {
          var opts = options || {};
          var onSuccess = typeof opts.onSuccess === "function" ? opts.onSuccess : null;
          var onError = typeof opts.onError === "function" ? opts.onError : null;
          var actionLabel = opts.actionLabel || successText || fnName;
          if (confirmText && !window.confirm(confirmText)) return;
          setLoading(button, true);
          rxSetCurrent("INFO", "Running " + actionLabel + "...");
          callServer(fnName, undefined, function (err, res) {
            setLoading(button, false);
            if (err) {
              rxPush("ERROR", actionLabel + " failed.");
              return;
            }
            if (!res.ok) {
              if (onError) {
                onError(res);
                return;
              }
              var reason = res && res.reason ? String(res.reason) : "";
              var msg = res && res.message ? String(res.message) : "Action failed.";
              var upper = reason.toUpperCase();
              var level = (upper.indexOf("BLOCK") >= 0 || upper.indexOf("GUARD") >= 0 || upper.indexOf("MODE_NOT") === 0 || upper === "ENV_NOT_READY" || upper === "TRIGGERS_ACTIVE" || upper === "OCR_ENABLE_BLOCKED")
                ? "WARN"
                : "ERROR";
              if (level === "WARN") {
                rxPush("WARN", actionLabel + " blocked: " + msg);
              } else {
                rxPush("ERROR", actionLabel + " failed: " + msg);
              }
              return;
            }
            rxPush("OK", successText || (actionLabel + " completed."));
            if (onSuccess) {
              try {
                onSuccess(res);
              } catch (e) {
                // ignore post-success errors
              }
            }
          });
        }

        function initTabs() {
          var buttons = document.querySelectorAll(".tab-btn");
          buttons.forEach(function (btn) {
            btn.addEventListener("click", function () {
              buttons.forEach(function (b) {
                b.setAttribute("aria-selected", "false");
              });
              btn.setAttribute("aria-selected", "true");
              var panels = document.querySelectorAll(".tab-panel");
              panels.forEach(function (panel) {
                panel.classList.remove("active");
              });
              var target = document.getElementById(btn.getAttribute("aria-controls"));
              if (target) target.classList.add("active");
            });
          });
        }

        function initDashboard() {
          var btnRefreshOverview = document.getElementById("btn-refresh-overview");
          var btnRefreshLogs = document.getElementById("btn-refresh-logs");
          var btnQueue = document.getElementById("btn-queue");
          var btnOcrEnable = document.getElementById("btn-ocr-enable");
          var btnOcrDisable = document.getElementById("btn-ocr-disable");
          var btnEnterMaintenance = document.getElementById("btn-enter-maintenance");
          var btnExportRun = document.getElementById("btn-export-run");
          var btnArchiveLogs = document.getElementById("btn-archive-logs");
          var btnExitMaintenance = document.getElementById("btn-exit-maintenance");

          appState.controls = {
            btnQueue: btnQueue,
            btnOcrEnable: btnOcrEnable,
            btnOcrDisable: btnOcrDisable,
            btnEnterMaintenance: btnEnterMaintenance,
            btnExportRun: btnExportRun,
            btnArchiveLogs: btnArchiveLogs,
            btnExitMaintenance: btnExitMaintenance
          };

          btnRefreshOverview.addEventListener("click", function () {
            refreshOverview({ history: true, button: btnRefreshOverview });
          });
          btnRefreshLogs.addEventListener("click", function () {
            refreshLogs({ history: true, button: btnRefreshLogs });
          });
          btnQueue.addEventListener("click", function () {
            runOp(btnQueue, "belle_dash_opQueue", null, "Queue completed.", {
              actionLabel: "Queue files",
              onSuccess: function () {
                refreshOverview({
                  button: btnRefreshOverview,
                  onError: function () {
                    rxSetCurrent("ERROR", "Queue completed, but overview refresh failed.");
                  }
                });
              }
            });
          });
          btnOcrEnable.addEventListener("click", function () {
            runOp(btnOcrEnable, "belle_dash_opOcrEnable", null, "OCR enabled.", {
              actionLabel: "OCR enable",
              onSuccess: function () {
                refreshOcrRunStatus();
              }
            });
          });
          btnOcrDisable.addEventListener("click", function () {
            runOp(btnOcrDisable, "belle_dash_opOcrDisable", "Disable OCR workers?", "OCR disabled.", {
              actionLabel: "OCR disable",
              onSuccess: function () {
                refreshOcrRunStatus();
              }
            });
          });
          btnEnterMaintenance.addEventListener("click", function () {
            runOp(btnEnterMaintenance, "belle_dash_enterMaintenance", "Enter maintenance mode?", "Maintenance mode enabled.", {
              actionLabel: "Enter maintenance",
              onSuccess: function (res) {
                if (res && res.data) applyModeState(res.data);
                else refreshMode();
              }
            });
          });
          btnExportRun.addEventListener("click", function () {
            runOp(btnExportRun, "belle_dash_exportRun", "Run export and clear operational sheets?", "Export run completed.", {
              actionLabel: "Export run"
            });
          });
          btnArchiveLogs.addEventListener("click", function () {
            runOp(btnArchiveLogs, "belle_dash_archiveLogs", "Archive and clear logs?", "Logs archived and cleared.", {
              actionLabel: "Archive logs"
            });
          });
          btnExitMaintenance.addEventListener("click", function () {
            runOp(btnExitMaintenance, "belle_dash_exitMaintenance", null, "Maintenance mode disabled.", {
              actionLabel: "Exit maintenance",
              onSuccess: function (res) {
                if (res && res.data) applyModeState(res.data);
                else refreshMode();
              }
            });
          });

          initTabs();
          refreshMode();
          refreshOcrRunStatus();
          refreshOverview({ button: btnRefreshOverview });
          refreshLogs({ button: btnRefreshLogs });
        }

        function initSetup() {
          var btnRecheck = document.getElementById("btn-health-recheck");
          if (!btnRecheck) return;
          btnRecheck.addEventListener("click", function () {
            setLoading(btnRecheck, true);
            rxPush("INFO", "Re-checking environment...");
            callServer("belle_dashboard_healthCheck", undefined, function (err, res) {
              setLoading(btnRecheck, false);
              if (err) {
                rxPush("ERROR", "Health check failed.");
                return;
              }
              applyHealthResult(res || {});
              var data = res && res.data ? res.data : null;
              if (data && data.ready === true) {
                rxPush("OK", "Environment ready.");
              } else {
                rxPush("WARN", "Environment not ready.");
              }
            });
          });
        }

        function boot() {
          initSetup();
          var bootHealth = window.__BOOT_HEALTH__ || null;
          if (!bootHealth) {
            rxSetCurrent("WARN", "Environment not ready.");
            showSetupView({
              message: "Environment not ready.",
              data: { diagnostics: [{ item: "ENV_HEALTHCHECK", code: "MISSING", detail: "No boot data.", hint: "Re-check to load diagnostics." }] }
            });
            return;
          }
          applyHealthResult(bootHealth);
        }

        document.addEventListener("DOMContentLoaded", boot);
      })();
    </script>
  </body>
</html>
